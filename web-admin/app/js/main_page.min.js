!function(e){var t=angular.module("root",["ngRoute","YUNSOO_CONFIG","utils","interceptor","angularFileUpload","dataFilterService"]);t.config(["$routeProvider",function(e){e.when("/dashboard",{templateUrl:"pages/dashboard/dashboard.html",controller:"DashboardCtrl"}).when("/account",{templateUrl:"pages/account/account-manage.html",controller:"AccountManageCtrl"}).when("/product-base-manage",{templateUrl:"pages/product/product-base-manage.html",controller:"ProductBaseManageCtrl"}).when("/product-key-manage",{templateUrl:"pages/product/product-key-manage.html",controller:"ProductKeyManageCtrl"}).when("/message",{templateUrl:"pages/message/message.html",controller:"MessageCtrl"}).when("/package-manage",{templateUrl:"pages/package/packageManage.html",controller:"PackageCtrl"}).when("/package-search",{templateUrl:"pages/package/packageSearch.html",controller:"PackageSearchCtrl"}).when("/logistics",{templateUrl:"pages/logistics/logistics.html",controller:"LogisticsManageCtrl"}).when("/search",{templateUrl:"pages/search/search.html",controller:"SearchCtrl"}).when("/setting",{templateUrl:"pages/setting/setting.html",controller:"SettingCtrl"}).when("/emulator",{templateUrl:"pages/emulator/emulator.html",controller:"emulatorCtrl"}).when("/device",{templateUrl:"pages/device/device.html",controller:"deviceCtrl"}).otherwise({templateUrl:"pages/dashboard/dashboard.html",controller:"DashboardCtrl"})}]),t.factory("rootService",["$http","$rootScope",function(e){return{initContext:function(){var t=this;e.get("/api/account/current").success(function(e){t.account=e,console.log("[get current account]",e)}).error(function(e,t){console.log("[get current account]","failed",t)}),e.get("/api/organization/current").success(function(e){t.organization=e,console.log("[get current organization]",e)}).error(function(e,t){console.log("[get current organization]","failed",t)})}}}]),t.controller("rootCtrl",["$scope","$timeout","$http","YUNSOO_CONFIG","utils","rootService","productBaseManageService",function(t,n,o,a,r,i,c){console.log("[root controller start]"),t.YUNSOO_CONFIG=a,t.utils=r,t.context={getAccessToken:function(){var t=e.cookie(a.NAME_ACCESS_TOKEN);return"string"==typeof t?t:null}},t.context.getAccessToken()||(window.location.href="login.html"),t.productKeyCreditSum={total:0,remain:0,percentage:0},i.initContext.apply(t.context),c.getProductKeyCredits(function(n){var o=t.productKeyCreditSum;e.each(n,function(e,t){o.total+=t.total,o.remain+=t.remain}),o.percentage=100*o.remain/o.total|0,console.log("[get productKeyCreditSum]: ",o)}),n(function(){t.utils.notification("info","欢迎登陆云溯管理平台")},3e3),console.log("[root controller end]")}]),t.directive("scrollTop",function(){return{restrict:"A",scope:!0,link:function(t,n,o){if(!nifty.isMobile){var a=!1,r=250,i=e(window),c=e("body, html");i.scroll(function(){i.scrollTop()>r&&!a?(n.addClass("in"),a=!0):i.scrollTop()<r&&a&&(n.removeClass("in"),a=!1)}),n.on("click",function(e){e.preventDefault(),c.animate({scrollTop:0},500)})}}}}).directive("dtPageable",function(){return{restrict:"A",scope:{pageable:"=dtPageable"},templateUrl:"partials/widgets/pageable.html"}})}(jQuery),function(){var e=angular.module("login",["interceptor","YUNSOO_CONFIG"]);e.factory("loginService",["$http",function(e){return{login:function(t,n,o){e.post("/api/auth/login",{organization:t.organization,identifier:t.identifier,password:t.password}).success(n).error(o)},loginForm:function(e){return e?void(localStorage.loginForm=JSON.stringify(e)):localStorage.loginForm?JSON.parse(localStorage.loginForm):null}}}]),e.controller("LoginCtrl",["$scope","$timeout","loginService","YUNSOO_CONFIG",function(e,t,n,o){function a(){var a=e.loginForm;a.organization=$.trim(a.organization),a.identifier=$.trim(a.identifier),console.log("[before login]","organization:",a.organization,"identifier:",a.identifier),n.login(a,function(e){return e&&e.access_token&&e.access_token.token?($.removeCookie(o.NAME_ACCESS_TOKEN,{path:"/"}),$.cookie(o.NAME_ACCESS_TOKEN,e.access_token.token,{expires:e.access_token.expires_in/86400,path:"/"}),a.rememberMe&&(a.password="",console.log("[saving login form]"),n.loginForm(a)),$("body").addClass("animated fadeOut"),$("#panel-login").addClass("animated zoomOut"),void t(function(){window.location.href="index.html"},1e3)):void $.niftyNoty({type:"danger",container:"#panel-login",html:"登陆失败请稍后再试",focus:!1,timer:3e3})},function(t,n){console.log("[login failed]",t.message,n),e.loginForm.password="",$.niftyNoty({type:"danger",container:"#panel-login",html:"账号或密码错误",focus:!1,timer:3e3})})}(e.loginForm=n.loginForm())||(e.loginForm={organization:"",identifier:"",password:"",rememberMe:!1}),t(function(){$("form.bv-form").bootstrapValidator({message:"非法输入",feedbackIcons:{valid:"fa fa-check-circle fa-lg text-success",invalid:"fa fa-times-circle fa-lg",validating:"fa fa-refresh"},fields:{organization:{validators:{notEmpty:{message:"组织名称不可空"}}},identifier:{validators:{notEmpty:{message:"用户名不可空"}}},password:{validators:{notEmpty:{message:"密码不可空"}}}}}).on("success.form.bv",function(e,t){e.preventDefault(),a()})},0),t(function(){e.showLoginFormDelay=!0},1500)}])}(),function(e){"use strict";var t=angular.module("root");t.factory("navService",["$http",function(e){return{}}]),t.controller("NavCtrl",["$scope","navService",function(t,n){var o=e('#mainnav-menu > li > a, #mainnav-menu-wrap .mainnav-widget a[data-toggle="menu-widget"]'),a=e("#mainnav").height(),r=null,i=!1,c=!1,s=null,l=function(){var t;o.each(function(){var n=e(this),a=n.children(".menu-title"),r=n.siblings(".collapse"),i=e(n.attr("data-target")),c=i.length?i.parent():null,s=null,l=null,u=null,d=null,f=(n.outerHeight()-n.height()/4,function(){return i.length&&n.on("click",function(e){e.preventDefault()}),r.length?(n.on("click",function(e){e.preventDefault()}).parent("li").removeClass("active"),!0):!1}()),g=null,p=function(e){clearInterval(g),g=setInterval(function(){e.nanoScroller({preventPageScrolling:!0,alwaysVisible:!0}),clearInterval(g)},700)};e(document).click(function(t){e(t.target).closest("#mainnav-container").length||n.removeClass("hover").popover("hide")}),e("#mainnav-menu-wrap > .nano").on("update",function(e,t){n.removeClass("hover").popover("hide")}),n.popover({animation:!1,trigger:"manual",container:"#mainnav",viewport:n,html:!0,title:function(){return f?a.html():null},content:function(){var t;return f?(t=e('<div class="sub-menu"></div>'),r.addClass("pop-in").wrap('<div class="nano-content"></div>').parent().appendTo(t)):i.length?(t=e('<div class="sidebar-widget-popover"></div>'),i.wrap('<div class="nano-content"></div>').parent().appendTo(t)):t='<span class="single-content">'+a.html()+"</span>",t},template:'<div class="popover menu-popover"><h4 class="popover-title"></h4><div class="popover-content"></div></div>'}).on("show.bs.popover",function(){if(!s){if(s=n.data("bs.popover").tip(),l=s.find(".popover-title"),u=s.children(".popover-content"),!f&&0==i.length)return;d=u.children(".sub-menu")}!f&&0==i.length}).on("shown.bs.popover",function(){if(!f&&0==i.length){var t=0-.5*n.outerHeight();return void u.css({"margin-top":t+"px",width:"auto"})}var o=parseInt(s.css("top")),a=n.outerHeight(),r=function(){return nifty.container.hasClass("mainnav-fixed")?e(window).outerHeight()-o-a:e(document).height()-o-a}(),c=u.find(".nano-content").children().css("height","auto").outerHeight();u.find(".nano-content").children().css("height",""),o>r?(l.length&&!l.is(":visible")&&(a=Math.round(0-.5*a)),o-=5,u.css({top:"",bottom:a+"px",height:o}).children().addClass("nano").css({width:"100%"}).nanoScroller({preventPageScrolling:!0}),p(u.find(".nano"))):(!nifty.container.hasClass("navbar-fixed")&&nifty.mainNav.hasClass("affix-top")&&(r-=50),c>r?((nifty.container.hasClass("navbar-fixed")||nifty.mainNav.hasClass("affix-top"))&&(r-=a+5),r-=5,u.css({top:a+"px",bottom:"",height:r}).children().addClass("nano").css({width:"100%"}).nanoScroller({preventPageScrolling:!0}),p(u.find(".nano"))):(l.length&&!l.is(":visible")&&(a=Math.round(0-.5*a)),u.css({top:a+"px",bottom:"",height:"auto"}))),l.length&&l.css("height",n.outerHeight()),u.on("click",function(){u.find(".nano-pane").hide(),p(u.find(".nano"))})}).on("hidden.bs.popover",function(){n.removeClass("hover"),f?r.removeAttr("style").appendTo(n.parent()):i.length&&i.appendTo(c),clearInterval(t)}).on("click",function(){nifty.container.hasClass("mainnav-sm")&&(o.popover("hide"),n.addClass("hover").popover("show"))}).hover(function(){o.popover("hide"),n.addClass("hover").popover("show")},function(){clearInterval(t),t=setInterval(function(){s&&(s.one("mouseleave",function(){n.removeClass("hover").popover("hide")}),s.is(":hover")||n.removeClass("hover").popover("hide")),clearInterval(t)},500)})}),c=!0},u=function(){var t=e("#mainnav-menu").find(".collapse");t.length&&t.each(function(){var t=e(this);t.hasClass("in")?t.parent("li").addClass("active"):t.parent("li").removeClass("active")}),null!=r&&r.length&&r.nanoScroller({stop:!0}),o.popover("destroy").unbind("mouseenter mouseleave"),c=!1},d=function(){var t,n=nifty.container.width();t=740>=n?"xs":n>740&&992>n?"sm":n>=992&&1200>=n?"md":"lg",s!=t&&(s=t,nifty.screenSize=t,"sm"==nifty.screenSize&&nifty.container.hasClass("mainnav-lg")&&e.niftyNav("collapse"))},f=function(t){return nifty.mainNav.niftyAffix("update"),u(),d(),("collapse"==i||nifty.container.hasClass("mainnav-sm"))&&(nifty.container.removeClass("mainnav-in mainnav-out mainnav-lg"),l()),a=e("#mainnav").height(),i=!1,null},g={revealToggle:function(){nifty.container.hasClass("reveal")||nifty.container.addClass("reveal"),nifty.container.toggleClass("mainnav-in mainnav-out").removeClass("mainnav-lg mainnav-sm"),c&&u()},revealIn:function(){nifty.container.hasClass("reveal")||nifty.container.addClass("reveal"),nifty.container.addClass("mainnav-in").removeClass("mainnav-out mainnav-lg mainnav-sm"),c&&u()},revealOut:function(){nifty.container.hasClass("reveal")||nifty.container.addClass("reveal"),nifty.container.removeClass("mainnav-in mainnav-lg mainnav-sm").addClass("mainnav-out"),c&&u()},slideToggle:function(){nifty.container.hasClass("slide")||nifty.container.addClass("slide"),nifty.container.toggleClass("mainnav-in mainnav-out").removeClass("mainnav-lg mainnav-sm"),c&&u()},slideIn:function(){nifty.container.hasClass("slide")||nifty.container.addClass("slide"),nifty.container.addClass("mainnav-in").removeClass("mainnav-out mainnav-lg mainnav-sm"),c&&u()},slideOut:function(){nifty.container.hasClass("slide")||nifty.container.addClass("slide"),nifty.container.removeClass("mainnav-in mainnav-lg mainnav-sm").addClass("mainnav-out"),c&&u()},pushToggle:function(){nifty.container.toggleClass("mainnav-in mainnav-out").removeClass("mainnav-lg mainnav-sm"),nifty.container.hasClass("mainnav-in mainnav-out")&&nifty.container.removeClass("mainnav-in"),c&&u()},pushIn:function(){nifty.container.addClass("mainnav-in").removeClass("mainnav-out mainnav-lg mainnav-sm"),c&&u()},pushOut:function(){nifty.container.removeClass("mainnav-in mainnav-lg mainnav-sm").addClass("mainnav-out"),c&&u()},colExpToggle:function(){return nifty.container.hasClass("mainnav-lg mainnav-sm")&&nifty.container.removeClass("mainnav-lg"),nifty.container.toggleClass("mainnav-lg mainnav-sm").removeClass("mainnav-in mainnav-out"),nifty.window.trigger("resize")},collapse:function(){return nifty.container.addClass("mainnav-sm").removeClass("mainnav-lg mainnav-in mainnav-out"),i="collapse",nifty.window.trigger("resize")},expand:function(){return nifty.container.removeClass("mainnav-sm mainnav-in mainnav-out").addClass("mainnav-lg"),nifty.window.trigger("resize")},togglePosition:function(){nifty.container.toggleClass("mainnav-fixed"),nifty.mainNav.niftyAffix("update")},fixedPosition:function(){nifty.container.addClass("mainnav-fixed"),nifty.mainNav.niftyAffix("update")},staticPosition:function(){nifty.container.removeClass("mainnav-fixed"),nifty.mainNav.niftyAffix("update")},update:f,forceUpdate:d,getScreenSize:function(){return s}};e.niftyNav=function(e,t){if(g[e]){("colExpToggle"==e||"expand"==e||"collapse"==e)&&("xs"==nifty.screenSize&&"collapse"==e?e="pushOut":"xs"!=nifty.screenSize&&"sm"!=nifty.screenSize||"colExpToggle"!=e&&"expand"!=e||!nifty.container.hasClass("mainnav-sm")||(e="pushIn"));var n=g[e].apply(this,Array.prototype.slice.call(arguments,1));if(t)return t();if(n)return n}return null},e.fn.isOnScreen=function(){var e={top:nifty.window.scrollTop(),left:nifty.window.scrollLeft()};e.right=e.left+nifty.window.width(),e.bottom=e.top+nifty.window.height();var t=this.offset();return t.right=t.left+this.outerWidth(),t.bottom=t.top+this.outerHeight(),!(e.right<t.left||e.left>t.right||e.bottom<t.bottom||e.top>t.top)},nifty.window.on("resizeEnd",f).trigger("resize");var p=e(".mainnav-toggle");p.length&&p.on("click",function(t){t.preventDefault(),e.niftyNav(p.hasClass("push")?"pushToggle":p.hasClass("slide")?"slideToggle":p.hasClass("reveal")?"revealToggle":"colExpToggle")});var m=e("#mainnav-menu");m.length&&(m.metisMenu({toggle:!0}),r=nifty.mainNav.find(".nano"),r.length&&r.nanoScroller({preventPageScrolling:!0}));var h={};e("#mainnav").find("#mainnav-menu").find(">li").each(function(t,n){var o=e(n),a=o.find(">a").attr("href"),r={$html:o};a&&(h[a]=r),o.find(">ul>li").each(function(t,n){var o=e(n),a=o.find(">a").attr("href");a&&(h[a]={$html:o,parent:r})})}),t.$on("$routeChangeSuccess",function(t,n,o){var a=e("#mainnav");a.find("li.active-link").removeClass("active-link"),a.find("li.active-sub").removeClass("active-sub");var r=n.$$route?n.$$route.originalPath:"/dashboard",i=h["#"+r];i&&(i.$html.addClass("active-link"),i.parent&&(i.parent.$html.addClass("active-sub"),i.$html.parent("ul.collapse").addClass("in")))})}])}(jQuery),function(){var e=angular.module("root");e.factory("accountManageService",["$http",function(e){return{getAccounts:function(t,n){e.get("/api/account").success(t)}}}]),e.controller("AccountManageCtrl",["$scope","$timeout","accountManageService","dataFilterService",function(e,t,n,o){e.accountTable=new e.utils.DataTable({pageable:{page:0,size:20},flush:function(e){n.getAccounts(function(t,n,o){e({data:t,headers:o})})}})}])}(),function(){var e=angular.module("root");e.factory("dashboardService",["$http",function(e){return{}}]),e.controller("DashboardCtrl",["$scope","dashboardService",function(e,t){}])}(),function(){var e=angular.module("root");e.factory("deviceService",["$http",function(e){return{getDevices:function(t,n,o){var a="/api/device/org/"+n+"?";return a+=t.toString(),e.get(a).success(o),this},getCurrentOrgAccounts:function(t){var n="/api/account";return e.get(n).success(t),this}}}]),e.controller("deviceCtrl",["$scope","deviceService","$timeout",function(e,t,n){e.curOrgAccounts="",e.deviceComment="",e.deviceName="",e.selectAccount="",function o(){e.context.account?e.deviceTable=new e.utils.DataTable({sortable:{target:"#sort-bar",sort:"createdDateTime,desc"},pageable:{page:0,size:20},flush:function(n){t.getDevices(this,e.context.account.org_id,function(e,t,o){n({data:e,headers:o})})}}):n(o,1e3)}(),t.getCurrentOrgAccounts(function(t){e.curOrgAccounts=t}),e.deviceAuth=function(){if(""==e.selectAccount)return void $("#divSelectAccount").addClass("has-error").addClass("has-feedback");if(""==e.deviceName)return void $("#divDeviceName").addClass("has-error").addClass("has-feedback");$("#divDeviceName").addClass("has-success").addClass("has-feedback"),$("#divSelectAccount").addClass("has-success").addClass("has-feedback"),$("#authQRCode").html("");var t={};t.selectAccount=e.selectAccount,t.deviceName=e.deviceName,t.deviceComment=e.deviceComment,e.qrcode=$("#authQRCode").qrcode({render:"table",width:300,height:300,foreground:"#337ab7",text:"token"})},e.cancelDeviceAuth=function(){}}])}(),function(){var e=angular.module("root");e.factory("emulatorService",["$http",function(e){return{createProWithDetail:function(t,n,o){return e.post("/api/productbase/withdetail",t).success(n).error(o),this}}}]),e.controller("emulatorCtrl",["$scope","emulatorService","$timeout","FileUploader",function(e,t,n,o){var a=e.uploader=new o({url:""}),r=e.context.getAccessToken();r&&(a.headers[e.YUNSOO_CONFIG.HEADER_ACCESS_TOKEN]=r),e.productInfos=[{key:"",value:""}],e.productAddress=[{address:"",tel:""}],e.barCode="",e.productName="",e.expireDate=1,e.expireDateUnit="",e.comment="",e.fileInput="",e.keyTypePubInput="",e.keyTypePriInput="",e.keyTypeRFIDInput="",e.hotline="",e.support="",e.taobao="",e.tmall="",e.addProductInfo=function(){e.productInfos.push({key:"",value:""})},e.subProductInfo=function(){e.productInfos.pop()},e.addProAddress=function(){e.productAddress.push({address:"",tel:""})},e.subProAddress=function(){e.productAddress.pop()},e.preview=function(){var t={};t.orgImgUrl="/api/organization/"+e.context.organization.id+"/logo-mobile?access_token="+e.context.getAccessToken(),t.proImgUrl=e.fileInput,t.barcode=e.barCode,t.name=e.productName,t.details=e.productInfos,$("#iphone-6-portrait")[0].contentWindow.refresh(t)},e.submit=function(){if(""==e.barCode)return void e.utils.alert("info","产品BarCode不能为空");if(""==e.productName)return void e.utils.alert("info","产品名不能为空");if(!e.keyTypePubInput&&!e.keyTypePriInput&&!e.keyTypeRFIDInput)return void e.utils.alert("info","产品码类型至少要选择一种");if(""==e.expireDateUnit)return void e.utils.alert("info","请选择产品过期单位");if(!/(^[1-9]\d*$)/.test(e.expireDate))return void e.utils.alert("info","产品过期时间应为正整数");if(0==a.queue.length)return void e.utils.alert("info","产品图片不能为空");var n={};n.category_id=0,n.barcode=e.barCode,n.name=e.productName,n.comments=e.comment,n.product_key_type_codes=[],e.keyTypePubInput&&n.product_key_type_codes.push("qr_public"),e.keyTypePriInput&&n.product_key_type_codes.push("qr_secure"),e.keyTypeRFIDInput&&n.product_key_type_codes.push("rfid"),n.shelf_life=e.expireDate-0,"年"==e.expireDateUnit?n.shelf_life_interval="year":"月"==e.expireDateUnit?n.shelf_life_interval="month":"周"==e.expireDateUnit?n.shelf_life_interval="week":"天"==e.expireDateUnit?n.shelf_life_interval="day":"小时"==e.expireDateUnit&&(n.shelf_life_interval="hour"),n.status_code="待审核";var o={};o.details={};for(var i in e.productInfos)""!=e.productInfos[i].key&&""!=e.productInfos[i].value&&(o.details[e.productInfos[i].key]=e.productInfos[i].value);o.contact={},o.contact.hotline=e.hotline,o.contact.support=e.support,o["e-commerce"]={},o["e-commerce"].taobao=e.taobao,o["e-commerce"].tmall=e.tmall,o["t-commerce"]=[];for(var c in e.productAddress)if(""!=e.productAddress[c].address&&""!=e.productAddress[c].tel){var s={};s.address=e.productAddress[c].address,s.tel=e.productAddress[c].tel,o["t-commerce"].push(s)}n.details=JSON.stringify(o);try{t.createProWithDetail(n,function(t){null!=t.id&&""!=t.id&&(a.queue[0].url="/api/productbase/withdetailfile/"+t.id+"/full-mobile",a.queue[0].headers[e.YUNSOO_CONFIG.HEADER_ACCESS_TOKEN]=r,a.uploadAll(),e.utils.alert("success","创建产品成功"))},function(t,n){e.utils.alert("info","创建产品失败")})}catch(l){}},n(function(){!function(e){"use strict";var t,n=function(t){if(!t.data("nifty-check")){t.data("nifty-check",!0),t.text().trim().length?t.addClass("form-text"):t.removeClass("form-text");var n=t.find("input")[0],o=n.name,a=function(){return"radio"==n.type&&o?e(".form-radio").not(t).find("input").filter("input[name="+o+"]").parent():!1}(),r=function(){"radio"==n.type&&a.length&&a.each(function(){var t=e(this);t.hasClass("active")&&t.trigger("nifty.ch.unchecked"),t.removeClass("active")}),n.checked?t.addClass("active").trigger("nifty.ch.checked"):t.removeClass("active").trigger("nifty.ch.unchecked")};n.checked?t.addClass("active"):t.removeClass("active"),e(n).on("change",r)}},o={isChecked:function(){return this[0].checked},toggle:function(){return this[0].checked=!this[0].checked,this.trigger("change"),null},toggleOn:function(){return this[0].checked||(this[0].checked=!0,this.trigger("change")),null},toggleOff:function(){return this[0].checked&&"checkbox"==this[0].type&&(this[0].checked=!1,this.trigger("change")),null}};e.fn.niftyCheck=function(t){var a=!1;return this.each(function(){o[t]?a=o[t].apply(e(this).find("input"),Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t||n(e(this))}),a},nifty.document.ready(function(){t=e(".form-checkbox, .form-radio"),t.length&&t.niftyCheck()}),nifty.document.on("change",".btn-file :file",function(){var t=e(this),n=t.get(0).files?t.get(0).files.length:1,o=t.val().replace(/\\/g,"/").replace(/.*\//,""),a=function(){try{return t[0].files[0].size}catch(e){return"Nan"}}(),r=function(){if("Nan"==a)return"Unknown";var e=Math.floor(Math.log(a)/Math.log(1024));return 1*(a/Math.pow(1024,e)).toFixed(2)+" "+["B","kB","MB","GB","TB"][e]}();t.trigger("fileselect",[n,o,r])})}(jQuery);var t=$("#divImgWrap"),n=$("#fileInput"),o=$("#imgProductbase");"undefined"==typeof FileReader?t.html("您的浏览器不支持图片预览"):n.change(function(){var t=a.queue[0]._file,n=new FileReader;n.readAsDataURL(t),n.onload=function(t){o.attr("src",this.result),e.fileInput=this.result}}),$("#createProduct").bootstrapValidator({message:"该字段不能为空",feedbackIcons:{valid:"fa fa-check-circle fa-lg text-success",invalid:"fa fa-times-circle fa-lg",validating:"fa fa-refresh"},fields:{barCode:{validators:{notEmpty:{message:"请输入产品BarCode"}}},productName:{validators:{notEmpty:{message:"请输入产品名"}}},greaterthan:{validators:{notEmpty:{message:"请输入产品过期时间"},greaterThan:{inclusive:!1,value:0,message:"请输入大于1的正整数"}}}}}).on("success.field.bv",function(e,t){var n=t.element.parents(".form-group");n.removeClass("has-success")})},0)}])}(),function(){var e=angular.module("root");e.filter("startFrom",function(){return function(e,t){return e&&e.length?e.slice(t-1):void 0}}),e.factory("logisticsManageService",["$http",function(e){return{uploadLogisticsFile:function(t,n,o){return e.post("/api/logistics/file",t).success(function(e){}).error(function(e,t){}),this},getLogisticsHistoryInfoCount:function(t,n){return e.get("/api/productfile/count?status=0&&filetype=2").success(function(e){t(e)}).error(function(e,n){t()}),this},getLogisticsHistoryInfo:function(t,n,o){return e.get("/api/productfile?status=0&&filetype=2&&pageIndex="+t).success(function(e){n(e)}).error(function(e,t){n()}),this}}}]),e.controller("LogisticsManageCtrl",["$scope","FileUploader","logisticsManageService",function(e,t,n){var o=e.uploader=new t({url:"/api/logistics/file"}),a=e.context.getAccessToken();a&&(o.headers[e.YUNSOO_CONFIG.HEADER_ACCESS_TOKEN]=a),o.filters.push({name:"customFilter",fn:function(e,t){return this.queue.length<10},name:""}),o.onWhenAddingFileFailed=function(e,t,n){console.info("onWhenAddingFileFailed",e,t,n)},o.onAfterAddingFile=function(e){console.info("onAfterAddingFile",e)},o.onAfterAddingAll=function(e){console.info("onAfterAddingAll",e)},o.onBeforeUploadItem=function(e){console.info("onBeforeUploadItem",e)},o.onProgressItem=function(e,t){console.info("onProgressItem",e,t)},o.onProgressAll=function(e){console.info("onProgressAll",e)},o.onSuccessItem=function(t,n,o,a){console.info("onSuccessItem",n,o),e.utils.alert("success","上传成功！")},o.onErrorItem=function(e,t,n,o){console.info("onErrorItem",e,t,n,o)},o.onCancelItem=function(e,t,n,o){console.info("onCancelItem",e,t,n,o)},o.onCompleteItem=function(e,t,n,o){console.info("onCompleteItem",t,n),i(0)},o.onCompleteAll=function(){i(0)};var r=function(t){function n(){return t.length>0?1:0}function o(){this.onFirstPage()||(e.currentPage=0,i(e.currentPage))}function a(){this.onLastPage()||(e.currentPage=Math.ceil(e.totalCounts/this.pageSize)-1,i(e.currentPage))}function r(t){e.currentPage=t,i(e.currentPage)}function c(){return e.currentPage}function s(){for(var t=[],n=Math.max(0,e.currentPage-4);n<=e.currentPage;n++)t.push(n);return t}function l(){this.onLastPage()||(e.currentPage+=1,i(e.currentPage))}function u(){this.onFirstPage()||(e.currentPage-=1,i(e.currentPage))}function d(){return 0===e.currentPage}function f(){return t.length<this.pageSize}var g={data:t,filteredData:{},pageSize:10,pages:s,isShowHisSec:n,goToFirstPage:o,gotoLastPage:a,goToPage:r,currentPage:c,next:l,previous:u,onFirstPage:d,onLastPage:f};return g};e.currentPage=0,e.totalCounts=0,e.itemIndex=0,n.getLogisticsHistoryInfoCount(function(t){e.totalCounts=t});var i=function(t){n.getLogisticsHistoryInfo(t,function(t){e.data=t,e.dataTable=new r(e.data),e.isShowHisSec=e.data.length>0?1:0,e.itemIndex=0})};i(0)}])}(),function(){var e=angular.module("root");e.factory("logisticsService",["$http",function(e){return{getInfo:function(t,n,o){e.get("/api/logistics/"+t).success(function(e){n(e)}).error(function(e,t){n()})}}}]),e.controller("LogisticsCtrl",["$scope","logisticsService",function(e,t){e.productKey="",e.bodyShow=0,e.productKeyClick=function(){return null==e.productKey||""==e.productKey?void(e.bodyShow=0):void t.getInfo(e.productKey,function(t){e.bodyShow=1,e.data=t})}}])}(),function(){var e=angular.module("root");e.factory("messageService",["$http",function(e){return{getMessages:function(t,n,o){var a="/api/message?";n&&(a+="org_id="+n+"&"),a+=t.toString(),e.get(a).success(o)}}}]),e.controller("MessageCtrl",["$scope","$timeout","messageService",function(e,t,n){var o={business:"商家信息",platform:"云溯平台信息"},a={created:"已创建",approved:"通过审核",deleted:"已删除"};!function r(){e.context.account?e.messageTable=new e.utils.DataTable({sortable:{target:"#sort-bar",sort:"createdDateTime,desc"},pageable:{page:0,size:20},flush:function(t){n.getMessages(this,e.context.account.org_id,function(e,n,o){t({data:e,headers:o})})}}):t(r,1e3)}(),e.formatMessageType=function(e){return o[e]||e},e.formatMessageStatus=function(e){return a[e]||e}}])}(),function(){var e=angular.module("root");e.factory("operationService",["$http",function(e){return{getInfo:function(t,n,o){e.get("/api/logistics/"+t).success(function(e){n(e)}).error(function(e,t){n()})}}}]),e.controller("OperationCtrl",["$scope","operationService",function(e,t){e.productKey="",e.bodyShow=0,e.packageClick=function(){return null==e.productKey||""==e.productKey?void(e.bodyShow=0):void logisticsService.getInfo(e.productKey,function(t){e.bodyShow=1,e.data=t})}}])}(),function(){var e=angular.module("root");e.factory("packageSearchService",["$http",function(e){return{getInfo:function(t,n,o){e.get("/api/package/"+t).success(function(e){n(e)}).error(function(e,t){n()})}}}]),e.controller("PackageSearchCtrl",["$scope","packageSearchService",function(e,t){function n(e){if(null!=e){var t={};t.text=e.key,t.nodes=[];var o={};if(o.text="产品数量: ("+e.productCount+")",t.nodes.push(o),null!=e.subPackages){if(e.subPackages instanceof Array)for(var a in e.subPackages)t.nodes.push(n(e.subPackages[a]));else t.nodes.push(n(e.subPackages));return t}}}e.productKey="",e.bodyShow=0,e.productKeyClick=function(){return null==e.productKey||""==e.productKey?void(e.bodyShow=0):void t.getInfo(e.productKey,function(t){e.origialdata=t,e.resultdata=[],e.resultdata.push(n(t)),e.bodyShow=1,$("#tree").treeview({data:e.resultdata,color:"#3c8dbc"})})}}])}(),function(){var e=angular.module("root");e.factory("packageService",["$http",function(e){return{getInfo:function(t,n,o){return e.get("/api/package/"+productKey).success(function(e){n(e)}).error(function(e,t){n()}),this},uploadPackageFile:function(t,n,o){return e.post("/api/package/file",t).success(function(e){}).error(function(e,t){}),this},getPackageHistoryInfoCount:function(t,n){return e.get("/api/productfile/count?status=0&&filetype=1").success(function(e){t(e)}).error(function(e,n){t()}),this},getPackageHistoryInfo:function(t,n,o){return e.get("/api/productfile?status=0&&filetype=1&&pageIndex="+t).success(function(e){n(e)}).error(function(e,t){n()}),this}}}]),e.controller("PackageCtrl",["$scope","FileUploader","packageService",function(e,t,n){var o=e.uploader=new t({url:"/api/package/file"}),a=e.context.getAccessToken();a&&(o.headers[e.YUNSOO_CONFIG.HEADER_ACCESS_TOKEN]=a),o.filters.push({name:"customFilter",fn:function(e,t){return this.queue.length<10},name:""}),o.onWhenAddingFileFailed=function(e,t,n){console.info("onWhenAddingFileFailed",e,t,n)},o.onAfterAddingFile=function(e){console.info("onAfterAddingFile",e)},o.onAfterAddingAll=function(e){console.info("onAfterAddingAll",e)},o.onBeforeUploadItem=function(e){console.info("onBeforeUploadItem",e)},o.onProgressItem=function(e,t){console.info("onProgressItem",e,t)},o.onProgressAll=function(e){console.info("onProgressAll",e)},o.onSuccessItem=function(t,n,o,a){console.info("onSuccessItem",n,o),e.utils.alert("success","上传成功！")},o.onErrorItem=function(e,t,n,o){console.info("onErrorItem",e,t,n,o)},o.onCancelItem=function(e,t,n,o){console.info("onCancelItem",e,t,n,o)},o.onCompleteItem=function(e,t,n,o){console.info("onCompleteItem",t,n),i(0)},o.onCompleteAll=function(){i(0)};var r=function(t){function n(){return t.length>0?1:0}function o(){this.onFirstPage()||(e.currentPage=0,i(e.currentPage))}function a(){this.onLastPage()||(e.currentPage=Math.ceil(e.totalCounts/this.pageSize)-1,i(e.currentPage))}function r(t){e.currentPage=t,i(e.currentPage)}function c(){return e.currentPage}function s(){for(var t=[],n=Math.max(0,e.currentPage-4);n<=e.currentPage;n++)t.push(n);return t}function l(){this.onLastPage()||(e.currentPage+=1,i(e.currentPage))}function u(){this.onFirstPage()||(e.currentPage-=1,i(e.currentPage))}function d(){return 0===e.currentPage}function f(){return t.length<this.pageSize}var g={data:t,filteredData:{},pageSize:10,pages:s,isShowHisSec:n,goToFirstPage:o,gotoLastPage:a,goToPage:r,currentPage:c,next:l,previous:u,onFirstPage:d,onLastPage:f};return g};e.currentPage=0,e.totalCounts=0,e.itemIndex=0,e.getItemIndex=function(){return e.itemIndex+=1,e.itemIndex},n.getPackageHistoryInfoCount(function(t){e.totalCounts=t});var i=function(t){n.getPackageHistoryInfo(t,function(t){e.data=t,e.dataTable=new r(e.data),e.isShowHisSec=e.data.length>0?1:0,e.itemIndex=0})};i(0)}])}(),function(){var e=angular.module("root");e.factory("productBaseManageService",["$http",function(e){return{getProductBases:function(t){return e.get("/api/productbase").success(t),this},getProductKeyCredits:function(t){return e.get("/api/productkeycredit").success(t),this}}}]),e.controller("ProductBaseManageCtrl",["$scope","productBaseManageService",function(e,t){function n(n){t.getProductKeyCredits(function(t){var o={general:{total:0,remain:0},creditMap:{}};$.each(t,function(e,t){t.product_base_id?o.creditMap[t.product_base_id]={total:t.total,remain:t.remain}:o.general={total:t.total,remain:t.remain}}),e.productKeyCredits=o,console.log("[productKeyCredits loaded]",o),n(o)})}function o(e,t){$.each(e,function(e,n){if(n&&t){var o=n.credit={total:0,remain:0,general:t.general};o.total+=t.general.total,o.remain+=t.general.remain,t.creditMap[n.id]&&(o.total+=t.creditMap[n.id].total,o.remain+=t.creditMap[n.id].remain),o.percentage=100*o.remain/o.total|0}})}e.SHELFLIFE_INTERVALS={year:"年",month:"月",week:"周",day:"天",hour:"小时"},e.formatProductKeyTypes=function(e){var t="";return e&&$.each(e,function(n,o){t+=o.name,n<e.length-1&&(t+=", ")}),t},e.formatComments=function(e){return e||(e=""),e.length>30?e.substring(0,30)+"...":e},e.dataTable=new e.utils.DataTable({pageable:{page:0,size:20},flush:function(a){t.getProductBases(function(t,r,i){e.productKeyCredits?o(t,e.productKeyCredits):n(function(e){o(t,e)}),a({data:t,headers:i})})}})}])}(),function(){var e=angular.module("root");e.factory("productKeyManageService",["$http",function(e){return{getProductKeyBatches:function(t,n){return e.get("/api/productkeybatch"+(t?"?product_base_id="+t:"")).success(n),this},getProductKeyBatchesPaged:function(t,n,o){var a="/api/productkeybatch?";return n&&(a+="product_base_id="+n+"&"),a+=t.toString(),e.get(a).success(o),this},getProductBases:function(t){return e.get("/api/productbase").success(t),this},getProductKeyCredits:function(t){return e.get("/api/productkeycredit").success(t),this},getAccountById:function(t,n){return e.get("/api/account/"+t).success(n),this},createProductKeyBatch:function(t,n,o){return e.post("/api/productkeybatch",t).success(n).error(o),this},downloadProductKeys:function(e,t,n){e.downloadFrameSrc="/api/productkeybatch/"+t+"/keys?"+n}}}]),e.controller("ProductKeyManageCtrl",["$scope","productKeyManageService",function(e,t){
function n(e,t){if(e&&t){var n=e.credit={total:0,remain:0,general:t.general};n.total+=t.general.total,n.remain+=t.general.remain,t.creditMap[e.id]&&(n.total+=t.creditMap[e.id].total,n.remain+=t.creditMap[e.id].remain),n.percentage=100*n.remain/n.total|0}}e.cache||(e.cache={}),e.creationPanel={model:{productBaseId:0,quantity:0},create:function(){var n=this.model;console.log("[before productKeyBatch create]",n);var o={quantity:n.quantity,product_base_id:n.productBaseId},a=this.selectedProductBase;t.createProductKeyBatch(o,function(t){console.log("[newProductKeyBatch created]",t),t.product_base=a,a.credit.remain-=o.quantity,e.listPanel.newProductKeyBatches.push(t),e.utils.alert("success","产品码创建成功")},function(t,n){console.log(t,n);var o=(t.message||"").substring(0,100);e.utils.alert("danger",o)})},productBaseIdChanged:function(e){console.log("[productBaseId changed]",e);var t=null;$.each(this.productBases,function(n,o){o&&o.id===e&&(t=o,console.log("[selectedProductBase]",t))}),this.selectedProductBase=t}},e.listPanel={table:new e.utils.DataTable({sortable:{target:"#sort-bar",sort:"createdDateTime,desc"},pageable:{page:0,size:20},flush:function(e){t.getProductKeyBatchesPaged(this,null,function(t,n,o){e({data:t,headers:o})})}}),newProductKeyBatches:[],download:function(n){if(n){var o=e.context.getAccessToken(),a=o?e.YUNSOO_CONFIG.PARAMETER_ACCESS_TOKEN+"="+o:"";t.downloadProductKeys(this,n,a)}},downloadFrameSrc:""},e.formatProductKeyTypes=function(e){var t="";return e&&$.each(e,function(n,o){t+=o.name,n<e.length-1&&(t+=", ")}),t},e.cache.accounts||(e.cache.accounts=[]),e.getAccountCached=function(n){var o=e.cache.accounts;return o[n]?o[n]:(o[n]="加载中",void t.getAccountById(n,function(e){o[n]=e}))},t.getProductBases(function(o){e.productBases=e.creationPanel.productBases=o,e.productBaseMap=e.utils.arrayToMap(e.productBases,"id"),e.productBases&&t.getProductKeyCredits(function(t){var o={general:{total:0,remain:0},creditMap:{}};$.each(t,function(e,t){t.product_base_id?o.creditMap[t.product_base_id]={total:t.total,remain:t.remain}:o.general={total:t.total,remain:t.remain}}),e.productKeyCredits=o,console.log("[productKeyCredits loaded]",o),$.each(e.productBases,function(e,t){n(t,o)})})})}])}(),function(){var e=angular.module("root");e.controller("SearchCtrl",["$scope",function(e){}])}(),function(){var e=angular.module("root");e.factory("settingService",["$http",function(e){return{updatePassword:function(t,n,o){return e.post("/api/account/current/password",t).success(n).error(o),this}}}]),e.controller("SettingCtrl",["$scope","settingService","$timeout",function(e,t,n){e.originalPassword="",e.currentPassword="",e.confirmPassword="",n(function(){$("#updatePassword").bootstrapValidator({message:"输入密码不合法",feedbackIcons:{valid:"fa fa-check-circle fa-lg text-success",invalid:"fa fa-times-circle fa-lg",validating:"fa fa-refresh"},fields:{oldPassword:{validators:{notEmpty:{message:"请输入当前密码"}}},curPassword:{validators:{notEmpty:{message:"请输入修改密码"}}},confirmPassword:{validators:{notEmpty:{message:"请输入确认密码"},identical:{field:"curPassword",message:"确认密码与修改密码不一致"}}}}}).on("success.field.bv",function(e,t){var n=t.element.parents(".form-group");n.removeClass("has-success")})},0),e.submit=function(){if(""==e.originalPassword)return void e.utils.alert("warning","请输入原密码！");if(""==e.currentPassword)return void e.utils.alert("warning","请输入修改密码！");if(e.currentPassword!=e.confirmPassword)return void e.utils.alert("warning","确认密码与修改入密码不一致！");var n={old_password:e.originalPassword,new_password:e.currentPassword};t.updatePassword(n,function(t){e.utils.alert("success","修改密码成功！")},function(t){e.utils.alert("warning","修改密码失败！")})}}])}();