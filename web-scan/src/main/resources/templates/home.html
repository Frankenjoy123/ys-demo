<!DOCTYPE HTML>
<html ng-app="product">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <!-- Bootstrap -->
    <link href="bootstrap-3.3.4-dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="AdminLTE/AdminLTE.min.css" rel="stylesheet"/>
    <script src="angular-1.3.15/angular.min.js" type="text/javascript"></script>
    <script src="jquery-2.1.3/jquery-2.1.3.min.js" type="text/javascript"></script>
</head>
<body>
<!-- Content Header (Page header) -->
<script type="text/javascript">
    $(document).ready(function () {
        $("#tab_a_1").click(function () {
            $("#tab_1").addClass("active");
            $("#li_tab_a_1").addClass("active");

            $("#tab_2").removeClass("active");
            $("#li_tab_a_2").removeClass("active");

            $("#tab_3").removeClass("active");
            $("#li_tab_a_3").removeClass("active");
        });

        $("#tab_a_2").click(function () {
            $("#tab_2").addClass("active");
            $("#li_tab_a_2").addClass("active");

            $("#tab_1").removeClass("active");
            $("#li_tab_a_1").removeClass("active");

            $("#tab_3").removeClass("active");
            $("#li_tab_a_3").removeClass("active");
        });

        $("#tab_a_3").click(function () {
            $("#tab_3").addClass("active");
            $("#li_tab_a_3").addClass("active");

            $("#tab_1").removeClass("active");
            $("#li_tab_a_1").removeClass("active");

            $("#tab_2").removeClass("active");
            $("#li_tab_a_2").removeClass("active");
        });
    });

    (function () {
        var app = angular.module("product", []);

        app.factory("productService", ["$http", function ($http) {
            return {
                getInfo: function (postObject, fnSuccess, fnError) {
                    $http.post("/api/scan/mobile", postObject)
                            .success(function (data) {
                                fnSuccess(data);
                            }).error(function (data, state) {
                                fnSuccess();
                            });
                }
            };
        }]);

        app.controller("productCtrl", ["$scope", "productService", function ($scope, productService) {

            $scope.showSection = 0;

            $scope.productKey = '<p th:text="${key}"/>';
            $scope.productKey = $scope.productKey.replace("<p>", "");
            $scope.productKey = $scope.productKey.replace("</p>", "");

            var postObject = {
                key: $scope.productKey,
                deviceCode: 'UIDSL-SD832-230DS-623043',
                location: '用户选择不公开',
                latitude: 120.798,
                longitude: 34.678
            };

            Date.prototype.toCommonCase = function () {
                var xYear = this.getYear();
                xYear = xYear + 1900;

                var xMonth = this.getMonth() + 1;
                if (!(xMonth > 9)) {
                    xMonth = "0" + xMonth;
                }

                var xDay = this.getDate();
                if (!(xDay > 9)) {
                    xDay = "0" + xDay;
                }

                var xHours = this.getHours();
                if (!(xHours > 9)) {
                    xHours = "0" + xHours;
                }

                var xMinutes = this.getMinutes();
                if (!(xMinutes > 9)) {
                    xMinutes = "0" + xMinutes;
                }

                var xSeconds = this.getSeconds();
                if (!(xSeconds > 9)) {
                    xSeconds = "0" + xSeconds;
                }

                return xYear + "-" + xMonth + "-" + xDay + " " + xHours + ":" + xMinutes + ":" + xSeconds;
            }

            $scope.getDateString = function (value) {
                var date = new Date(value);
                return date.toCommonCase();
            };

            $scope.productKeyClick = function () {

                if ($scope.productKey == null || $scope.productKey == "") {
                    return;
                }

                productService.getInfo(postObject, function (data) {

                    $scope.showSection = 1;

                    if (data == null || data.product == null)
                    {
                        $scope.isValidKey = 0;
                        return;
                    }

                    $scope.isValidKey = 1;
                    $scope.data = data;

                    if ($scope.data.product.details != null) {

                        $scope.detailItems = [];
                        var details = $scope.data.product.details.split(";");
                        for (var detail in details) {
                            var dat = details[detail];
                            var datItems = dat.split(":");

                            var item = {};
                            item.text = datItems[0];
                            item.value = datItems[1];
                            $scope.detailItems.push(item);
                        }
                    }

                    $scope.logisticsShow = 0;

                    if ($scope.data.logisticsList != null) {
                        $scope.latestLogistics = $scope.data.logisticsList[0];
                        $scope.otherLogistics = $scope.data.logisticsList.slice(1);

                        $scope.logisticsShow = 1;
                    }

                    $("#imgProduct").attr("src", "/api/productbase/thumbnail/" + $scope.data.product.productBaseId + "/thumb-mobile");
                    if ($scope.data.validationResult.toLowerCase() == "uncertain") {
                        $("#imgReal").attr("src", "images/jinggao_53.png");
                    }
                    else if ($scope.data.validationResult.toLowerCase() == "fake") {
                        $("#imgReal").attr("src", "images/jiahuo_52.png");
                    }
                    else if ($scope.data.validationResult.toLowerCase() == "real") {
                        $("#imgReal").attr("src", "images/zhengpin_54.png");
                    }
                });
            };

            $scope.productKeyClick();
        }]);

    })();
</script>
<div ng-controller="productCtrl" class="container">

    <br/>

    <div class="row" ng-show="showSection">
        <div class="col-xs-18 col-sm-12 col-md-12" ng-show="isValidKey" align="center">
            <img id="imgProduct" src="" width="40%" class="img-circle"/>
            <img id="imgReal" src="" width="40%" class="img-circle"/>
        </div>
        <div class="col-xs-18 col-sm-12 col-md-12 bg-primary" ng-show="!isValidKey" align="center">
            <img src="images/ysdefault.jpg" class="img-circle"/>
        </div>
    </div>

    <br/>

    <div class="row" ng-show="showSection">
        <div class="col-xs-18 col-md-12 bg-primary" ng-show="isValidKey">
            <h4><p class="">云溯科技提醒： 您是第{{data.scanCounter}}次扫描！</p></h4>
        </div>
        <div class="col-xs-18 col-md-12" ng-show="!isValidKey" align="center">
            <img src="images/images_44.png" class="img-circle" width="80%"/>
        </div>
    </div>

    <br/>

    <div class="row" ng-show="showSection">
        <div class="col-xs-18 col-md-12" ng-show="isValidKey">
            <div class="nav-tabs-custom">
                <ul class="nav nav-tabs">
                    <li class="active" id="li_tab_a_1"><a id="tab_a_1" data-toggle="tab">基本信息</a></li>
                    <li id="li_tab_a_2"><a id="tab_a_2" data-toggle="tab">扫描信息</a></li>
                    <li id="li_tab_a_3"><a id="tab_a_3" data-toggle="tab">物流跟踪</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="tab_1">
                        <div class="panel box box-primary">
                            <div class="table-responsive">
                                <table class="table table-condensed">
                                    <tr>
                                        <td>商品码</td>
                                        <td>{{data.product.productKey}}</td>
                                    </tr>
                                    <tr>
                                        <td>物品名称</td>
                                        <td>{{data.product.name}}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2">商品描述</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2">
                                            <table class="table table-condensed">
                                                <tr ng-repeat="detail in detailItems">
                                                    <td>{{detail.text}}</td>
                                                    <td>{{detail.value}}</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane" id="tab_2">
                        <div class="panel box box-primary">
                            <div class="table-responsive">
                                <table class="table table-condensed">
                                    <tr ng-repeat="scan in data.scanRecord">
                                        <td>{{scan.detail}}</td>
                                        <td>{{getDateString(scan.createdDateTime)}}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane" id="tab_3">
                        <div class="panel box box-primary">
                            <ul class="timeline" ng-show="!logisticsShow">
                                <li>
                                    <i class="fa fa-envelope bg-blue"></i>

                                    <div class="timeline-item">
                                        <h3 class="timeline-header">您没有物流信息！</h3>
                                    </div>
                                </li>
                            </ul>
                            <ul class="timeline" ng-show="logisticsShow">
                                <li>
                                    <i class="fa fa-envelope bg-blue"></i>

                                    <div class="timeline-item">
                                        <h3 class="timeline-header">{{getDateString(latestLogistics.dateTime)}}
                                            {{latestLogistics.message}} {{latestLogistics.location}}</h3>
                                    </div>
                                </li>
                                <li ng-repeat="logistics in otherLogistics">
                                    <i class="fa fa-envelope"></i>

                                    <div class="timeline-item">
                                        <h3 class="timeline-header">{{getDateString(logistics.dateTime)}}
                                            {{logistics.message}} {{logistics.location}}</h3>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-18 col-md-12 bg-primary" ng-show="!isValidKey" align="center">
            <h3><p class="">云溯科技提醒</p><p class="">无效的云溯产品码！</p></h3>
        </div>
    </div>
</div>
</body>
</html>
